{% extends theme('layouts/1-column.html') %}
{% from theme('macros/follow.html') import follow_btn with context %}
{% from theme('macros/integrate.html') import integrate_btn with context %}
{% from theme('macros/paginator.html') import paginator with context %}
{% from theme('macros/breadcrumb.html') import breadcrumb with context %}
{% from theme('macros/banner_info.html') import banner_info %}

## FIXME: remove inspire:indentifier robots condition when geo.data.gouv.fr is shutdown
{% set meta = {
    'title': dataset.full_title,
    'description': dataset.description|mdstrip(60)|forceescape,
    'image': dataset.organization and dataset.organization.logo(external=True) or '',
    'keywords': [_('dataset')] + dataset.tags,
    'robots': 'noindex, nofollow' if dataset.is_hidden or 'inspire:identifier' in dataset.extras else '',
} %}

{% set bundle = 'dataset' %}
{% set body_class = 'dataset-display' %}
{% set community_subtitle = _('Explore with %(certifier)s', certifier=config.SITE_TITLE ) %}
{% set read_only_mode = config.READ_ONLY_MODE %}
{# Harvesting source #}
{% set external_source = dataset.extras['remote_url'] %}

{% block extra_head %}
{% cache cache_duration, 'dataset-extra-head', dataset.id|string, g.lang_code %}
<link rel="canonical" href="{{ url_for('datasets.show', dataset=dataset) }}" />
<link rel="alternate" type="application/json+oembed" href="{{ url_for('api.oembed', url=dataset.external_url) }}"
    title="{{ dataset.title | urlencode }}" />
{% endcache %}
{% endblock %}

{% block breadcrumb %}
{% cache cache_duration, 'dataset-breadcrumb', dataset.id|string, g.lang_code %}
<li><a href="{{ url_for('datasets.list') }}">{{ _('Datasets') }}</a></li>
<li class="active">{{ dataset.acronym or dataset.title|truncate(128) }}</li>
{% endcache %}
{% endblock %}

{% block content %}
{% cache cache_duration, 'dataset-content', dataset.id|string, reuses.page|string, g.lang_code, current_user.slug or 'anonymous' %}

{{ breadcrumb(self,
    breadcrum_class=breadcrum_class,
    toolbar_class=toolbar_class
) }}

<section
    class="content container fr-mb-6w overflow-visible {% if not dataset.organization.public_service %}non{% endif %}certified {% if dataset.archived %}archived{% endif %}">
    {% if dataset.private %}
    <span class="fr-tag"
        title="{{ _('This dataset is private and will not be visible by other users') }}">{{ _('Private') }}
    </span>
    {% endif %}
    {% if dataset.deleted %}
    <span class="fr-tag"
        title="{{ _('This dataset has been deleted. This will be permanent in the next 24 hours') }}">{{ _('Deleted') }}
    </span>
    {% endif %}
    {% if dataset.archived %}
    {% set title = _('This dataset has been archived automatically because it has been deleted from the remote platform.')
        if dataset.extras.get('harvest:archived') == 'not-on-remote' else
        _('This dataset has been archived.') %}
    <span class="fr-tag" title="{{ title }}">
        {{ _('Archived') }}
    </span>
    {% endif %}
    {# FIXME: remove when geo.data.gouv.fr is shutdown #}
    {% if 'geop:dataset_id' in dataset.extras %}
    <div class="well well-warning py-sm mb-lg">
        ⚠️ {{ _("This dataset is handled by the <a href='{geo_link}'>geo.data.gouv.fr</a> platform.
        This platform is not actively maintained and as a result, you may find some bogus data or metadata.
        More information about <a href='{blog_link}'>the shutdown of geo.data.gouv.fr is available here.</a>").format(
            geo_link='https://geo.data.gouv.fr',
            blog_link='https://www.data.gouv.fr/fr/posts/extinction-de-geo-data-gouv-fr/'
        )}}
    </div>
    {% endif %}
    <div class="row fr-mb-2w">
        <div class="col">
            <h1 class="fr-mb-0 fr-h1">
                {{ dataset.title }}
                {% if dataset.acronym %}<small>{{ dataset.acronym }}</small>{% endif %}
            </h1>
            <p class="fr-mb-0">
                {% if not external_source %}
                {{ _('Updated on %(date)s', date=dataset.last_modified|dateformat(format='long')) }}
                    {% if dataset.license %}
                    &mdash;
                    {%  endif %}
                {% endif %}
                {% if dataset.license %}
                {% if dataset.license.url %}<a href="{{ dataset.license.url }}">{% endif %}
                {{ dataset.license.title }}
                {% if dataset.license.url %}</a>{% endif %}
                {% endif %}
            </p>
        </div>
        <div class="col-auto fr-mt-1v row-inline align-items-end flex-direction-column">
            {{ follow_btn(dataset) }}
            {% if can_edit %}
                <a
                    class="fr-btn fr-btn--secondary fr-btn--secondary-grey-500 fr-mt-2w fr-fi-edit-line fr-btn--icon-left fr-displayed-sm"
                    href="{{ url_for('admin.index', path='dataset/{id}/'.format(id=dataset.id)) }}"
                >
                    {{ _('Modify dataset') }}
                </a>
                <a
                class="fr-btn fr-btn--secondary fr-btn--secondary-grey-500 fr-mt-2w fr-fi-edit-line fr-hidden-sm"
                href="{{ url_for('admin.index', path='dataset/{id}/'.format(id=dataset.id)) }}"
            >
                {{ _('Modify dataset') }}
            </a>
            {% endif %}
            {% if sysadmin %}
            <div class="fr-mt-0 vuejs">
                <featured-button subject-id="{{ dataset.id }}" subject-type="dataset" :featured="{{ dataset.featured|tojson|safe }}"></featured-button>
            </div>
            {% endif %}
        </div>
    </div>
    {% if external_source %}
        {{ banner_info(
            "fr-fi-external-link-line",
            _("This dataset come from an external portal.&nbsp;<a href='{external_source}'>View the original source.</a>")
            .format(external_source=external_source)
        )}}
    {% endif %}
    {% if dataset.owner %}
    <div class="row">
        <div class="well well-grey-100 col fr-py-3v">
            {% trans
                    date=dataset.created_at|dateformat(format='long'),
                    update=dataset.last_modified|dateformat(format='long'),
                    author=dataset.owner.fullname
                %}This dataset has been published on the initiative and under the responsibility of
            {{author}}<br />Published on {{date}} and updated on {{update}}{% endtrans %}
        </div>
    </div>
    {% endif %}
    <div class="fr-grid-row fr-grid-row--gutters fr-mt-4w">
        <div class="fr-col-12 fr-col-md-8">
            <div class="fr-tabs">
                <ul class="fr-tabs__list" role="tablist" aria-label="{{ _('Dataset informations') }}">
                    <li role="presentation">
                        <button id="tab-producer" class="fr-tabs__tab"
                                tabindex="0" role="tab" aria-selected="true" aria-controls="tab-producer-panel">
                            {% if dataset.organization %}
                                {{ _('Producer') }}
                            {% elif dataset.owner %}
                                {{ _('Author') }}
                            {% endif %}
                        </button>
                    </li>
                    <li role="presentation">
                        <button id="tab-metadata" class="fr-tabs__tab"
                                tabindex="-1" role="tab" aria-selected="false" aria-controls="tab-metadata-panel">
                            {{ _('Metadata') }}
                        </button>
                    </li>
                    <li role="presentation">
                        <button id="tab-actions" class="fr-tabs__tab"
                                tabindex="-1" role="tab" aria-selected="false" aria-controls="tab-actions-panel">
                            {{ _('Actions') }}
                        </button>
                    </li>
                </ul>
                <div id="tab-producer-panel" class="fr-tabs__panel fr-tabs__panel--selected" role="tabpanel"
                     aria-labelledby="tab-producer" tabindex="0">
                    {% if dataset.organization %}
                    {% with organization=dataset.organization, producer_type='organization' %}
                    {% include theme('organization/producer-summary.html') %}
                    {% endwith %}
                    {% elif dataset.owner %}
                    {% with organization=dataset.owner, producer_type='owner' %}
                    {% include theme('organization/producer-summary.html') %}
                    {% endwith %}
                    {% endif %}
                </div>
                <div id="tab-metadata-panel" class="fr-tabs__panel" role="tabpanel"
                     aria-labelledby="tab-metadata" tabindex="0">
                    {% if dataset.tags %}
                    <ul class="fr-tags-group fr-mb-3v">
                        {% for tag in dataset.tags %}
                        <li>
                            <a
                                href="{{ url_for('datasets.list', tag=tag) }}"
                                title="{{ tag }}"
                                class="fr-tag"
                            >
                                {{ tag|truncate(35, True) }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-sm-4 fr-col-md-6 fr-col-lg-4">
                            <h2 class="subtitle">{{ _('Informations') }}</h2>
                            <dl class="metadata">
                                {% if dataset.license %}
                                <dt>{{ _('License') }}</dt>
                                 <dd>
                                     {% if dataset.license.url %}<a href="{{ dataset.license.url }}">{% endif %}
                                     {{ dataset.license.title }}
                                     {% if dataset.license.url %}</a>{% endif %}
                                 </dd>
                                {% endif %}
                                <dt>{{ _('ID') }}</dt>
                                 <dd>
                                     {{dataset.id}}
                                 </dd>
                                {% if external_source %}
                                <dt>{{ _('Remote source') }}</dt>
                                <dd><a rel="nofollow" href="{{ external_source }}">{{ _('Remote source') }}</a></dd>
                                {% endif%}
                            </dl>
                        </div>
                        <div class="fr-col-12 fr-col-sm-4 fr-col-md-6 fr-col-lg-4">
                            <h2 class="subtitle">{{ _('Temporality') }}</h2>
                            <dl class="metadata">
                                {% if dataset.temporal_coverage %}
                                <dt>{{ _('Temporal coverage') }}</dt>
                                <dd>{{ dataset.temporal_coverage|daterange(details=True) }}</dd>
                                {% endif %}
                                {% if dataset.frequency %}
                                <dt>{{ _('Frequency') }}</dt>
                                <dd>{{ dataset.frequency_label }}</dd>
                                {% endif %}
                                <dt>{{ _('Creation date') }}</dt>
                                <dd>{{ dataset.created_at|dateformat(format='long') }}</dd>
                                <dt>{{ _('Latest resource update') }}</dt>
                                <dd>{{ dataset.last_update|dateformat(format='long') }}</dd>
                            </dl>
                        </div>
                        {% if dataset.spatial %}
                        <div class="fr-col-12 fr-col-sm-4 fr-col-md-6 fr-col-lg-4">
                            <h2 class="subtitle">{{ _('Geographic dimensions') }}</h2>
                            <dl class="metadata">
                                {% if dataset.spatial.granularity %}
                                <dt>{{ _('Territorial coverage granularity') }}</dt>
                                <dd>{{ dataset.spatial.granularity_label }}</dd>
                                {% endif %}
                                {% if dataset.spatial.zones %}
                                <dt>{{ _('Territorial coverage') }}</dt>
                                <dd>
                                    {% for zone in dataset.spatial.zones %}
                                    {{zone.name}}{% if not loop.last %},{% endif %}
                                    {% endfor %}
                                </dd>
                                {% endif %}
                            </dl>
                        </div>
                        {% endif %}
                    </div>
                    {% if dataset.extras %}
                        <details>
                            <summary class="subtitle fr-mb-0">{{ _('Extras') }}</summary>
                            <dl class="metadata fr-my-0 fr-grid-row fr-grid-row--gutters">
                                {% for extra_name, extra_value in dataset.extras.items() %}
                                <div class="fr-col-12 fr-col-sm-4 fr-col-md-6 fr-col-lg-4">
                                    <dt>{{ extra_name }}</dt>
                                    <dd>{{ extra_value }}</dd>
                                </div>
                                {% endfor %}
                            </dl>
                        </details>
                {% endif %}
                </div>
                <div id="tab-actions-panel" class="fr-tabs__panel" role="tabpanel"
                     aria-labelledby="tab-actions" tabindex="0">
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-12 fr-col-sm-6 vuejs">
                            <h2 class="subtitle">{{ _('Participate') }}</h2>
                            <a class="fr-btn fr-btn--secondary fr-btn--secondary-grey-500 fr-fi-arrow-right-s-line fr-btn--icon-right"
                                href="{{ url_for('admin.index', path='reuse/new/', **{'dataset_id': dataset.id}) }}">
                                {{ _('Add a reuse') }}
                            </a>
                            <a class="fr-btn fr-btn--secondary fr-btn--secondary-grey-500 fr-fi-arrow-right-s-line fr-btn--icon-right fr-mt-3v"
                               href="#"
                               @click.prevent="$bus.emit('discussions.startThread')">
                                {{ _('Contact the producer') }}
                            </a>
                        </div>
                        <div class="fr-col-12 fr-col-sm-6">
                            <h2 class="subtitle">{{ _('Embed') }}</h2>
                            {{integrate_btn(dataset)}}
                            <h2 class="subtitle fr-mt-3w">{{ _('Permalink') }}</h2>
                            <div class="embed-wrapper">
                                <input
                                    readonly
                                    id="permalink"
                                    onClick="this.select();"
                                    value="{{ dataset.external_url }}"
                                />
                                <label
                                    for="permalink"
                                    class="icon-copy"
                                    id="permalink-copy"
                                    data-clipboard-target="#permalink"
                                >
                                    <span class="visually-hidden">{{ _('Copy this') }}</span>
                                    {% include theme('svg/copy.svg') %}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="fr-col-12 fr-col-md-4 fr-mt-5w">
            <nav class="fr-summary" role="navigation" aria-labelledby="fr-summary-title">
                <div class="fr-summary__title" id="fr-summary-title">{{ _('Summary') }}</div>
                <ol class="fr-summary__list">
                    <li>
                        <a class="fr-summary__link" href="#description">
                            {{ _('Description') }}
                        </a>
                    </li>
                    <li>
                        <a class="fr-summary__link" href="#resources">
                            {{ _('Resources') }} <sup class="sup">{{dataset.resources | length}}</sup>
                        </a>
                    </li>
                    <li>
                        <a class="fr-summary__link" href="#community-resources">
                            {{ _('Community resources') }}
                            <sup class="sup">{{ dataset.community_resources|length }}</sup>
                        </a>
                    </li>
                    <li>
                        <a class="fr-summary__link" href="#community-reuses">
                            {{ _('Reuses') }}  <sup class="sup">{{ total_reuses }}</sup>
                        </a>
                    </li>
                    <li>
                        <a class="fr-summary__link" href="#community-discussions">
                            {{ _('Discussions') }} <sup class="sup discussions-count">0</sup>
                        </a>
                    </li>
                </ol>
            </nav>
        </div>
    </div>
</section>
<section class="bg-contrast-grey fr-py-5w">
    <div class="container vuejs">
        <h2 id="description" class="fr-h2 fr-mb-0">{{ _('Description') }}</h2>
        <read-more>
            {{ dataset.description|markdown }}
        </read-more>
    </div>
</section>
<section class="ressources fr-py-10w">
    <div class="container">
        <h2 id="resources" class="fr-h2">{{ _('Resources') }} <sup>{{dataset.resources | length}}</sup></h2>
        {% if dataset.community_resources|length or 1 %}
        <a class="nav-link" href="#community-resources">{{ _('See also: community resources') }}</a>
        {% endif %}

        <div class="ressources-files fr-my-4w vuejs">
            {% set show_all_resources = request.args.get('resources') == 'all' %}
            {% set grouped_resources = dataset.resources|group_resources_by_type %}
            {% set nb_groups = grouped_resources.keys()|length %}
            {% set resources_per_page = config.RESOURCES_DEFAULT_PAGE_SIZE %}
            {% for (type, type_label), resources in grouped_resources.items() %}
                {% if nb_groups > 1 %}
                    <h3 class="fr-h6 fr-mb-3v fr-mt-9v">{{ type_label }} <sup>{{resources|length }}</sup></h3>
                {% endif %}
                <dataset-resources dataset-id="{{ dataset.id }}" type="{{ type }}" type-label="{{ type_label }}" :can-edit="{{ can_edit.can()|tojson|safe }}">
                    {% set max_resources_to_show = resources_per_page if not show_all_resources else resources|length %}
                    {% for resource in resources[:max_resources_to_show] %}
                        {% with expanded = "true" %}
                        {% include theme('dataset/resource/card.html') %}
                        {% endwith %}
                    {% endfor %}
                    {% if resources|length > resources_per_page and not show_all_resources %}
                        <a class="fr-btn fr-btn--secondary fr-mt-2w" href="?resources=all">
                            {{ _('See the %(nb)d resources of type %(type)s', nb=resources|length, type=type_label) }}
                        </a>
                    {% endif %}
                </dataset-resources>
            {% else %}
                <p class="text-center">{{ _('No resources') }}</p>
            {% endfor %}
        </div>
        {# Maybe put this after the real description instead of after the resource cards ? Not sure #}
        {{ hook('dataset.display.after-description') }}
    </div>
</section>
{% block community %}
<section class="community_container fr-pb-7w" id="community">
    <div class="container">
        <h2 id="community-resources" class="fr-h2">{{ _('Community resources') }}
            <sup>{{ dataset.community_resources|length }}</sup></h2>
        <div class="row fr-mb-3w">
            <div class="col-6 col-md-12 text-grey-380">
                <p>{{ _('You have built a more comprehensive database than those presented here? This is the time to share it!') }}
                </p>
            </div>
        </div>

        {% if not read_only_mode %}
        <div class="resource-list">
            {% for resource in dataset.community_resources %}
            {% include theme('dataset/resource/card.html') %}
            {% endfor %}
            {% if not read_only_mode %}
            <a class="btn-action fr-mt-3w"
                href="{{ url_for('admin.index', path='community-resource/new/', **{'dataset_id': dataset.id}) }}">
                {% include theme("svg/actions/add.svg") %}{{ _('Add a community resource') }}
            </a>
            {% endif %}
        </div>
        {% endif %}

        {% block reuses_section %}
        <div class="fr-grid-row fr-mt-12w">
            <h2 id="community-reuses" class="fr-h2 fr-col">{{ _('Reuses') }} <sup>{{ total_reuses }}</sup></h2>
            {% if not read_only_mode %}
                <div class="fr-col-12 fr-col-sm-6 fr-col-md-5 fr-col-lg-4 text-align-right">
                    <a class="fr-btn fr-btn--secondary btn-secondary btn-secondary-grey-500 fr-fi-add-line fr-btn--icon-left"
                        href="{{ url_for('admin.index', path='reuse/new/', **{'dataset_id': dataset.id}) }}">
                        {{ _('Add a reuse') }}
                    </a>
                </div>
            {% endif %}
        </div>
        <p class="fr-my-0">{{ _('Explore the reuses of this dataset.') }}</p>
        <p class="fr-mt-0 fr-mb-3w">{{ _('Did you use this data ? Reference your work and increase your visibility.') }}</p>
        <div class="fr-pt-2w fr-pt-md-0 fr-grid-row fr-grid-row--gutters fr-mb-2w">
            {% for reuse in reuses %}
            <div class="fr-mb-3v fr-col-lg-3 fr-col-sm-6 fr-col-12">
                {% include theme('reuse/card.html') %}
            </div>
            {% endfor %}
        </div>
        {{ paginator(reuses, arg_name='reuses_page', url='#community-reuses') }}
        {% endblock %}
        <div class="vuejs fr-mt-7w">
            <discussion-threads
                ref="discussions"
                subject-id="{{ dataset.id }}"
                subject-class="{{ dataset.__class__.__name__ }}"
            >
                {% if dataset.organization %}
                    <p>{{ _('Discussion between the organization and the community about this dataset.') }}</p>
                {% elif dataset.owner %}
                    <p>{{ _('Discussion between the owner and the community about this dataset.') }}</p>
                {% endif %}
            </discussion-threads>
        </div>
    </div>
</section>
{% endblock %}
{% endcache %}
{% endblock %}
