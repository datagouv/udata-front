{% extends theme('layouts/1-column.html') %}
{% from theme('macros/dataset_informations.html') import information_col, information_section %}
{% from theme('macros/follow.html') import follow_btn with context %}
{% from theme('macros/integrate.html') import integrate_btn with context %}
{% from theme('macros/paginator.html') import paginator with context %}
{% from theme('macros/breadcrumb.html') import breadcrumb with context %}
{% from theme('macros/banner_info.html') import banner_info %}
{% from theme('macros/banner_warning.html') import banner_warning %}
{% from theme('macros/quality_score_without_tooltip.html') import quality_score_without_tooltip %}

## FIXME: remove inspire:indentifier robots condition when geo.data.gouv.fr is shutdown
{% set meta = {
    'title': dataset.full_title,
    'description': dataset.description|mdstrip(60)|forceescape,
    'image': dataset.organization and dataset.organization.logo(external=True) or '',
    'keywords': [_('dataset')] + dataset.tags,
    'robots': 'noindex, nofollow' if dataset.is_hidden or 'inspire:identifier' in dataset.extras else '',
} %}

{% set bundle = 'dataset' %}
{% set body_class = 'dataset-display' %}
{% set community_subtitle = _('Explore with %(certifier)s', certifier=config.SITE_TITLE ) %}
{% set read_only_mode = config.READ_ONLY_MODE %}
{# Harvesting source #}

{% block extra_head %}
{% cache cache_duration, 'dataset-extra-head', dataset.id|string, g.lang_code, dataset.last_modified|string %}
<link rel="canonical" href="{{ url_for('datasets.show', dataset=dataset) }}" />
<link rel="alternate" type="application/json+oembed" href="{{ url_for('api.oembed', url=dataset.external_url) }}"
    title="{{ dataset.title | urlencode }}" />
{% endcache %}
{% endblock %}

{% block breadcrumb %}
{% cache cache_duration, 'dataset-breadcrumb', dataset.id|string, g.lang_code, dataset.last_modified|string %}
<li><a href="{{ url_for('datasets.list') }}">{{ _('Datasets') }}</a></li>
<li class="active" aria-current="page">{{ dataset.acronym or dataset.title|truncate(128) }}</li>
{% endcache %}
{% endblock %}

{% block toolbar %}
{% cache cache_duration, 'dataset-breadcrumb', dataset.id|string, g.lang_code, dataset.last_modified|string %}
{{ follow_btn(dataset) }}
{% if can_edit %}
    <div class="fr-col-auto fr-ml-3v">
        <a
            class="fr-btn fr-btn--secondary fr-btn--secondary-warning-425 fr-icon-edit-line fr-btn--icon-left fr-hidden fr-unhidden-sm"
            href="{{ url_for('admin.index', path='dataset/{id}/'.format(id=dataset.id)) }}"
        >
            {{ _('Edit') }}
        </a>
        <a
        class="fr-btn fr-btn--secondary fr-btn--secondary-warning-425 fr-icon-edit-line fr-hidden-sm"
        href="{{ url_for('admin.index', path='dataset/{id}/'.format(id=dataset.id)) }}"
        >
            {{ _('Edit') }}
        </a>
    </div>
{% endif %}
{% endcache %}
{% endblock %}

{% block content %}
{% cache cache_duration, 'dataset-content', dataset.id|string, reuses.page|string, g.lang_code, current_user.slug or 'anonymous', dataset.last_modified|string %}

{{ breadcrumb(self) }}

<div class="content fr-container fr-mb-10v">
    <!--{% if dataset.private %}
    <span class="fr-tag"
        title="{{ _('This dataset is private and will not be visible by other users') }}">{{ _('Private') }}
    </span>
    {% endif %}
    {% if dataset.deleted %}
    <span class="fr-tag"
        title="{{ _('This dataset has been deleted. This will be permanent in the next 24 hours') }}">{{ _('Deleted') }}
    </span>
    {% endif %}
    {% if dataset.archived %}
    {% set title = _('This dataset has been archived automatically because it has been deleted from the remote platform.')
        if dataset.harvest and dataset.harvest.archived == 'not-on-remote' else
        _('This dataset has been archived.') %}
    <span class="fr-tag" title="{{ title }}">
        {{ _('Archived') }}
    </span>
    {% endif %}
    {% if dataset.extras %}
        <details>
            <summary class="subtitle fr-mb-0">{{ _('Extras') }}</summary>
            <dl class="fr-my-0 fr-grid-row fr-grid-row--gutters">
                {% for extra_name, extra_value in dataset.extras.items() %}
                <div class="fr-col-12 fr-col-sm-4 fr-col-md-6 fr-col-lg-4">
                    <dt class="fr-text--sm fr-mb-0 text-mention-grey">{{ extra_name }}</dt>
                    <dd class="fr-text--sm fr-ml-0 fr-mb-2w">{{ extra_value }}</dd>
                </div>
                {% endfor %}
            </dl>
        </details>
    {% endif %}
    {% if dataset.harvest %}
        <details>
            <summary class="subtitle fr-mb-0">{{ _('Harvest') }}</summary>
            <dl class="fr-my-0 fr-grid-row fr-grid-row--gutters">
                {% for harvest_extra_name, harvest_extra_value in dataset.harvest._data.items() %}
                {% if harvest_extra_value != None %}
                <div class="fr-col-12 fr-col-sm-4 fr-col-md-6 fr-col-lg-4">
                    <dt class="fr-text--sm fr-mb-0 text-mention-grey">{{ harvest_extra_name }}</dt>
                    <dd class="fr-text--sm fr-ml-0 fr-mb-2w">{{ harvest_extra_value }}</dd>
                </div>
                {% endif %}
                {% endfor %}
            </dl>
        </details>
    {% endif %}
    <h2 class="subtitle subtitle--uppercase">{{ _('Embed') }}</h2>
    {{integrate_btn(dataset)}}
    <h2 class="subtitle fr-mt-3w">{{ _('Permalink') }}</h2>
    <div class="embed-wrapper">
        <input
            readonly
            id="permalink"
            onClick="this.select();"
            value="{{ dataset.external_url }}"
        />
        <label
            for="permalink"
            class="icon-copy"
            id="permalink-copy"
            data-clipboard-target="#permalink"
        >
            <span class="visually-hidden">{{ _('Copy this') }}</span>
            {% include theme('svg/copy.svg') %}
        </label>
    </div>
-->
    <h1 class="fr-mb-0 fr-h3">
        {{ dataset.title }}
        {% if dataset.acronym %}<small>{{ dataset.acronym }}</small>{% endif %}
    </h1>
    <div class="fr-grid-row fr-grid-row--gutters fr-mt-3w vuejs">
        <section class="fr-col-12 fr-col-md-8">
            <h2 id="description" class="subtitle fr-mb-1w">{{ _('Description') }}</h2>
            <read-more>
                {{ dataset.description|markdown }}
            </read-more>
        </section>
        <section class="fr-col-12 fr-col-md-4">
            {% if sysadmin %}
            <div class="fr-m-0">
                <featured-button subject-id="{{ dataset.id }}" subject-type="dataset" :featured="{{ dataset.featured|tojson|safe }}"></featured-button>
            </div>
            {% endif %}
            {% if dataset.organization %}
                <h2 id="producer" class="subtitle fr-mb-1w">{{ _('Producer') }}</h2>
                {% with organization=dataset.organization, producer_type='organization' %}
                {% include theme('organization/producer-name-with-logo.html') %}
                {% endwith %}
            {% elif dataset.owner %}
                <h2 id="author" class="subtitle fr-mb-1w">{{ _('Author') }}</h2>
                {% with organization=dataset.owner, producer_type='owner' %}
                {% include theme('organization/producer-name-with-logo.html') %}
                {% endwith %}
                <p class="well well-grey-100 fr-py-3v fr-my-5v">
                    {% trans
                            date=dataset.created_at|dateformat(format='long'),
                            update=dataset.last_modified|dateformat(format='long'),
                            author=dataset.owner.fullname
                        %}This dataset has been published on the initiative and under the responsibility of
                    {{author}}<br />Published on {{date}} and updated on {{update}}{% endtrans %}
                </p>
            {% endif %}
            {% if external_source(dataset) %}
            {{ banner_info(
                "fr-icon-external-link-line",
                _("This dataset come from an external portal.&nbsp;<a href='{external_source}'>View the original source.</a>")
                .format(external_source=external_source(dataset))
            )}}
            {% endif %}
            {# FIXME: remove when geo.data.gouv.fr is shutdown #}
            {% if 'geop:dataset_id' in dataset.extras %}
            <p class="well well-warning fr-py-3v fr-my-5v">
                ⚠️ {{ _("This dataset is handled by the <a href='{geo_link}'>geo.data.gouv.fr</a> platform.
                This platform is not actively maintained and as a result, you may find some bogus data or metadata.
                More information about <a href='{blog_link}'>the shutdown of geo.data.gouv.fr is available here.</a>").format(
                    geo_link='https://geo.data.gouv.fr',
                    blog_link='https://www.data.gouv.fr/fr/posts/extinction-de-geo-data-gouv-fr/'
                )}}
            </p>
            {% endif %}
            {{ hook('dataset.display.transport-banner') }}
            <h2 class="subtitle fr-mt-5v fr-mb-1v">{{ _('Latest update') }}</h2>
            <p class="fr-text--sm fr-mt-0 fr-mb-5v">
                {{ dataset.last_update|dateformat(format='long') }}
            </p>
            {% if dataset.license %}
            <h2 class="subtitle fr-mt-5v fr-mb-1v">{{ _('License') }}</h2>
            <p class="fr-text--sm fr-mt-0 fr-mb-5v">
                <code class="bg-alt-grey fr-px-1v text-grey-380">
                {% if dataset.license.url %}<a href="{{ dataset.license.url }}">{% endif %}
                {{ dataset.license.title }}
                {% if dataset.license.url %}</a>{% endif %}
                </code>
            </p>
            {% endif %}
            {{quality_score_without_tooltip(dataset)}}
        </section>
    </div>
</div>
<div class="fr-tabs fr-tabs--full-page">
    <div class="fr-container">
        <ul class="fr-tabs__list" role="tablist" aria-label="{{ _('In-page navigation') }}">
            <li role="presentation">
                <button id="tabpanel-404" class="fr-tabs__tab" tabindex="0" role="tab" aria-selected="true" aria-controls="tabpanel-404-panel">Label Tab 1</button>
            </li>
            <li role="presentation">
                <button id="tabpanel-405" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-405-panel">Label Tab 2</button>
            </li>
            <li role="presentation">
                <button
                    id="discussions-tab"
                    class="fr-tabs__tab"
                    tabindex="-1"
                    role="tab"
                    aria-selected="false"
                    aria-controls="discussions"
                >
                    {{_('Discussions')}}
                    <sup>{{ dataset.discussions|length }}</sup>
                </button>
            </li>
            <li role="presentation">
                <button
                    id="community-resources-tab"
                    class="fr-tabs__tab"
                    tabindex="-1"
                    role="tab"
                    aria-selected="false"
                    aria-controls="community-resources"
                >
                    {{ _('Community resources') }}
                    <sup>{{ dataset.community_resources|length }}</sup>
                </button>
            </li>
            <li role="presentation">
                <button
                    id="informations-tab"
                    class="fr-tabs__tab"
                    tabindex="-1"
                    role="tab"
                    aria-selected="false"
                    aria-controls="informations"
                >
                    {{ _("Informations") }}
                </button>
            </li>
        </ul>
    </div>
    <div id="tabpanel-404-panel" class="fr-tabs__panel fr-tabs__panel--selected" role="tabpanel" aria-labelledby="tabpanel-404" tabindex="0">
        <!-- données de test -->
        <p>Contenu 1</p>
    </div>
    <div id="tabpanel-405-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tabpanel-405" tabindex="0">
        <!-- données de test -->
        <p>Contenu 2</p>
    </div>
    <div id="discussions" class="fr-tabs__panel" role="tabpanel" aria-labelledby="discussions-tabs" tabindex="0">
        <div class="fr-container">
            <div class="vuejs">
                <discussion-threads
                    ref="discussions"
                    subject-id="{{ dataset.id }}"
                    subject-class="{{ dataset.__class__.__name__ }}"
                >
                    {% if dataset.organization %}
                        <p>{{ _('Discussion between the organization and the community about this dataset.') }}</p>
                    {% elif dataset.owner %}
                        <p>{{ _('Discussion between the owner and the community about this dataset.') }}</p>
                    {% endif %}
                </discussion-threads>
            </div>
        </div>
    </div>
    <div
        id="community-resources"
        class="fr-tabs__panel"
        role="tabpanel"
        aria-labelledby="community-resources-tab"
        tabindex="0"
    >
        <div class="fr-container">
            {% if dataset.community_resources|length %}
            {{ banner_warning(
                "fr-icon-alert-line",
                _("These resources are published by the community and the producer isn't responsible for them.")
            )}}
            {% endif %}
            <div class="resource-list vuejs">
                <dataset-resources
                    dataset-id="{{ dataset.id }}"
                    type="community"
                    type-label="{{ _('Community resources') }}"
                    :can-edit-resources='{{ dataset.community_resources|permissions|tojson|safe }}'
                    :show-title="false"
                >
                </dataset-resources>
                <noscript>
                    {% for resource in dataset.community_resources %}
                    {% include theme('dataset/resource/card.html') %}
                    {% endfor %}
                </noscript>
            </div>
        </div>
    </div>
    <div
        id="informations"
        class="fr-tabs__panel"
        role="tabpanel"
        aria-labelledby="informations-tab"
        tabindex="0"
    >
        <div class="fr-container">
        {% call() information_section(_('Informations')) %}
            <h3 class="subtitle fr-mb-1v">{{_('Tags')}}</h3>
            {% if dataset.tags %}
            <ul class="fr-tags-group fr-mb-3v">
                {% for tag in dataset.tags %}
                <li>
                    <a
                        href="{{ url_for('datasets.list', tag=tag) }}"
                        title="{{ tag }}"
                        class="fr-tag fr-tag--sm"
                    >
                        {{ tag|truncate(35, True) }}
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% endif %}
            <div class="fr-grid-row fr-grid-row--gutters">
                {% if dataset.license %}
                    {% call() information_col(_('License')) %}
                        <code class="bg-alt-grey fr-px-1v text-grey-380">
                            {% if dataset.license.url %}<a href="{{ dataset.license.url }}">{% endif %}
                            {{ dataset.license.title }}
                            {% if dataset.license.url %}</a>{% endif %}
                        </code>
                    {% endcall %}
                {% endif %}
                {% call() information_col(_('ID')) %}
                    {{dataset.id}}
                {% endcall %}
                {% if external_source(dataset) %}
                {% call() information_col(_('Remote source'), 'text-overflow-ellipsis') %}
                    <a rel="nofollow" href="{{ external_source(dataset) }}">{{external_source(dataset)}}</a>
                {% endcall %}
                {% endif %}
            </div>
        {% endcall %}
        {% call() information_section(_('Temporality')) %}
            <div class="fr-grid-row fr-grid-row--gutters">
                {% call() information_col(_('Creation')) %}
                    {{dataset.created_at|dateformat(format='long')}}
                {% endcall %}
                {% if dataset.frequency %}
                    {% call() information_col(_('Frequency')) %}
                        {{dataset.frequency_label}}
                    {% endcall %}
                {% endif %}
                {% if temporal_coverage %}
                    {% call() information_col(_('Temporal coverage')) %}
                        {{dataset.temporal_coverage|daterange(details=True)}}
                    {% endcall %}
                {% endif %}
            </div>
        {% endcall %}
        {% if dataset.spatial %}
            {% call() information_section(_('Spatial coverage')) %}
                {% if dataset.spatial.zones %}
                    {% call() information_col(_('Territorial coverage')) %}
                        {% for zone in dataset.spatial.zones %}
                        {{zone.name}}{% if not loop.last %},{% endif %}
                        {% endfor %}
                    {% endcall %}
                {% endif %}
                {% if dataset.spatial.granularity %}
                    {% call() information_col(_('Territorial coverage granularity')) %}
                        {{dataset.spatial.granularity_label}}
                    {% endcall %}
                {% endif %}
            {% endcall %}
        {% endif %}
        </div>
    </div>
</div>
<section class="ressources fr-py-10w">
    <div class="fr-container">
        {% set count_resources = dataset.resources | length %}
        <h2 id="resources" class="fr-h2">{{ _('Files') }} <sup class="resources-count">{{count_resources}}</sup></h2>
        <div class="ressources-files fr-my-4w vuejs">
            {% if count_resources > config.RESOURCES_MIN_COUNT_TO_SHOW_SEARCH %}
                <search-bar event-name="resources.search"></search-bar>
            {% endif %}
            {% set show_all_resources = request.args.get('resources') == 'all' %}
            {% set grouped_resources = dataset.resources|group_resources_by_type %}
            {% set nb_groups = grouped_resources.keys()|length %}
            {% set has_multiple_groups = nb_groups > 1 %}
            {% set resources_per_page = config.RESOURCES_DEFAULT_PAGE_SIZE %}
            {% for (type, type_label), resources in grouped_resources.items() %}
                <dataset-resources
                    dataset-id="{{ dataset.id }}"
                    type="{{ type }}"
                    type-label="{{ type_label }}"
                    :can-edit="{{ can_edit.can()|tojson|safe }}"
                    :show-total="{{ has_multiple_groups|tojson|safe }}"
                >
                </dataset-resources>
                <noscript>
                    <h3 class="fr-mt-4w fr-mb-1w fr-text--sm fr-text--bold text-transform-uppercase">
                        {{ type_label }} {% if has_multiple_groups %}<sup>{{resources|length }}</sup>{% endif %}
                    </h3>
                    {% set max_resources_to_show = resources_per_page if not show_all_resources else resources|length %}
                    {% for resource in resources[:max_resources_to_show] %}
                    {% include theme('dataset/resource/card.html') %}
                    {% endfor %}
                    {% if resources|length > resources_per_page and not show_all_resources %}
                        <a class="fr-btn fr-btn--secondary fr-mt-2w" href="?resources=all">
                            {{ _('See the %(nb)d resources of type %(type)s', nb=resources|length, type=type_label) }}
                        </a>
                    {% endif %}
                </noscript>
            {% else %}
                <p class="text-center">{{ _('No resources') }}</p>
            {% endfor %}
        </div>
        {# Maybe put this after the real description instead of after the resource cards ? Not sure #}
        {{ hook('dataset.display.after-description') }}
    </div>
</section>
{% block community %}
<section class="community_container fr-pb-7w" id="community">
    <div class="fr-container">
        {% block reuses_section %}
        <div class="fr-grid-row fr-mt-12w">
            <h2 id="community-reuses" class="fr-h2 fr-col">{{ _('Reuses') }} <sup>{{ total_reuses }}</sup></h2>
            {% if not read_only_mode %}
                <div class="fr-col-12 fr-col-sm-6 fr-col-md-5 fr-col-lg-4 text-align-right">
                    <a class="fr-btn fr-btn--secondary fr-btn--secondary-grey-500 fr-icon-add-line fr-btn--icon-left"
                        href="{{ url_for('admin.index', path='reuse/new/', **{'dataset_id': dataset.id}) }}">
                        {{ _('Add a reuse') }}
                    </a>
                </div>
            {% endif %}
        </div>
        <p class="fr-my-0">{{ _('Explore the reuses of this dataset.') }}</p>
        <p class="fr-mt-0 fr-mb-3w">{{ _('Did you use this data ? Reference your work and increase your visibility.') }}</p>
        <div class="fr-pt-2w fr-pt-md-0 fr-grid-row fr-grid-row--gutters fr-mb-2w">
            {% for reuse in reuses %}
            <div class="fr-mb-3v fr-col-lg-3 fr-col-sm-6 fr-col-12">
                {% include theme('reuse/card.html') %}
            </div>
            {% endfor %}
        </div>
        {{ paginator(reuses, arg_name='reuses_page', url='#community-reuses') }}
        {% endblock %}
    </div>
</section>
{% endblock %}
{% endcache %}
{% endblock %}
